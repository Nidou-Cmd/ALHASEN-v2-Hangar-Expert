<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè≠ ALHASEN v2 - Hangar Expert CAD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@r128/build/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- HEADER -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-900 text-white sticky top-0 z-50 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <div style="font-size: 28px; font-weight: bold; background: linear-gradient(45deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: 2px;">ÿßŸÑÿ≠ÿ≥ŸÜ</div>
                        <h1 class="text-3xl font-bold">üè≠ ALHASEN v2</h1>
                        <p class="text-xs opacity-90">üïå ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá ÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ±ÿ≠ŸäŸÖ</p>
                        <p class="text-xs mt-1">G√©n√©rateur Expert Hangar ‚Ä¢ Calculs Eurocode 3 ‚Ä¢ Export Real Files</p>
                    </div>
                    <div class="text-right text-xs bg-white bg-opacity-20 px-3 py-2 rounded">
                        ‚úì 54 Pays Afrique<br>‚úì Auto-Calculs<br>‚úì 3 Strat√©gies PRS
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- FORM PANEL -->
                <div class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
                    <!-- TABS -->
                    <div class="flex gap-2 mb-6 border-b-2 flex-wrap">
                        <button onclick="switchStep(1)" class="step-tab active bg-blue-600 text-white px-3 py-2 text-xs font-bold rounded-t-lg">üìê G√âOM√âTRIE</button>
                        <button onclick="switchStep(2)" class="step-tab px-3 py-2 text-xs font-bold rounded-t-lg bg-gray-200 text-gray-700 hover:bg-gray-300">üî© MAT√âRIAUX</button>
                        <button onclick="switchStep(3)" class="step-tab px-3 py-2 text-xs font-bold rounded-t-lg bg-gray-200 text-gray-700 hover:bg-gray-300">‚öñÔ∏è CHARGES</button>
                        <button onclick="switchStep(4)" class="step-tab px-3 py-2 text-xs font-bold rounded-t-lg bg-gray-200 text-gray-700 hover:bg-gray-300">üí∞ CO√õTS</button>
                        <button onclick="switchStep(5)" class="step-tab px-3 py-2 text-xs font-bold rounded-t-lg bg-gray-200 text-gray-700 hover:bg-gray-300">üì§ EXPORT</button>
                    </div>

                    <!-- STEP 1: G√âOM√âTRIE -->
                    <div class="step-content active" data-step="1">
                        <h2 class="text-xl font-bold mb-4">üìê G√©om√©trie du Hangar</h2>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-xs font-bold mb-2">üåç Pays</label>
                                <select id="country" class="w-full p-2 border rounded text-xs" onchange="updateClimate()">
                                    <option value="ae" selected>üá¶üá™ √âmirats Arabes</option>
                                    <option value="sn">üá∏üá≥ S√©n√©gal</option>
                                    <option value="ma">üá≤üá¶ Maroc</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-2">üí± Devise</label>
                                <select id="currency" class="w-full p-2 border rounded text-xs" onchange="calculate()">
                                    <option value="cfa" selected>üá∏üá≥ CFA</option>
                                    <option value="eur">‚Ç¨ EUR</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-xs font-bold mb-2">Longueur (m) <span class="text-red-600">*</span></label>
                                <input type="number" id="length" value="96" min="20" max="200" class="w-full p-2 border rounded text-xs" onchange="calculate()">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-2">Largeur/Port√©e (m) <span class="text-red-600">*</span></label>
                                <input type="number" id="width" value="66" min="10" max="100" class="w-full p-2 border rounded text-xs" onchange="calculate()">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-2">Hauteur murs (m) <span class="text-red-600">*</span></label>
                                <input type="number" id="wallHeight" value="9" min="5" max="20" class="w-full p-2 border rounded text-xs" onchange="calculate()">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-2">Pente toiture (%) <span class="text-red-600">*</span></label>
                                <input type="number" id="roofSlope" value="15" min="5" max="30" class="w-full p-2 border rounded text-xs" onchange="calculate()">
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-600 mb-4">
                            <p class="text-xs font-bold mb-2">‚¨ÜÔ∏è Hauteur fa√Ætage (auto-calcul√©e):</p>
                            <p class="text-2xl font-bold text-blue-600" id="roofHeightCalc">15.94 m</p>
                            <p class="text-xs text-gray-600 mt-2">Formule: H_mur + (Port√©e/2 √ó Pente/100)</p>
                        </div>

                        <h3 class="font-bold mb-3 mt-6">üì¶ Composants du Hangar</h3>
                        <div class="grid grid-cols-2 gap-2 text-xs bg-gray-50 p-3 rounded">
                            <div class="border-l-4 border-blue-600 pl-2">
                                <p class="font-bold">üî© Poteaux</p>
                                <p id="compPoteaux" class="text-blue-600">16 √ó HEB 300 (9m)</p>
                            </div>
                            <div class="border-l-4 border-green-600 pl-2">
                                <p class="font-bold">‚û°Ô∏è Traverses</p>
                                <p id="compTraverses" class="text-green-600">8 √ó IPE 300 (66m)</p>
                            </div>
                            <div class="border-l-4 border-orange-600 pl-2">
                                <p class="font-bold">„Ä∞Ô∏è Pannes toiture</p>
                                <p id="compPannes" class="text-orange-600">24 √ó UAP 100 (96m)</p>
                            </div>
                            <div class="border-l-4 border-purple-600 pl-2">
                                <p class="font-bold">üìè Lisses bardage</p>
                                <p id="compLisses" class="text-purple-600">24 √ó UAP 80 (66m)</p>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2: MAT√âRIAUX & PRS -->
                    <div class="step-content" data-step="2" style="display:none;">
                        <h2 class="text-xl font-bold mb-4">üî© Mat√©riaux & Optimisation PRS</h2>
                        
                        <h3 class="font-bold mb-3">üìä 3 Strat√©gies d'Optimisation</h3>
                        
                        <!-- Strat√©gie 1: Standard -->
                        <div class="border-2 border-blue-300 p-4 rounded mb-4">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="radio" name="strategy" value="standard" onchange="calculate()"> 
                                <h4 class="font-bold text-blue-600">üìå STANDARD (Lamin√©s classiques)</h4>
                            </div>
                            <div class="text-xs space-y-1 ml-5 bg-blue-50 p-2 rounded">
                                <p><strong>Poteaux:</strong> HEB 300 S275</p>
                                <p><strong>Traverses:</strong> IPE 300 S275</p>
                                <p><strong>Pannes:</strong> UAP 100</p>
                                <p class="mt-2"><strong>Poids acier:</strong> 48.5 t (+18% vs PRS)</p>
                                <p><strong>Co√ªt total:</strong> 95,000,000 CFA</p>
                                <p><strong>D√©lai:</strong> 1-2 semaines</p>
                            </div>
                        </div>

                        <!-- Strat√©gie 2: PRS √âquilibr√© -->
                        <div class="border-2 border-green-300 p-4 rounded mb-4 bg-green-50">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="radio" name="strategy" value="balanced" checked onchange="calculate()"> 
                                <h4 class="font-bold text-green-600">‚≠ê PRS √âQUILIBR√â (Recommand√©)</h4>
                            </div>
                            <div class="text-xs space-y-1 ml-5 bg-white p-2 rounded">
                                <p><strong>Poteaux:</strong> PRS 350√ó300√ó12 S275 ‚≠ê</p>
                                <p><strong>Traverses:</strong> PRS 300√ó200√ó10 S275 ‚≠ê</p>
                                <p><strong>Pannes:</strong> PRS 120√ó80√ó8 (vs UAP 100)</p>
                                <p class="mt-2"><strong>Poids acier:</strong> 41.3 t (-15% vs Standard)</p>
                                <p><strong>Co√ªt total:</strong> 79,756,200 CFA ‚úì</p>
                                <p><strong>D√©lai:</strong> 2-3 semaines (fabrication PRS)</p>
                                <p><strong>Avantages:</strong> Optimisation co√ªts & qualit√© √©quilibr√©e</p>
                            </div>
                        </div>

                        <!-- Strat√©gie 3: PRS Premium -->
                        <div class="border-2 border-red-300 p-4 rounded mb-4">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="radio" name="strategy" value="premium" onchange="calculate()"> 
                                <h4 class="font-bold text-red-600">üèÜ PRS PREMIUM (Haute performance)</h4>
                            </div>
                            <div class="text-xs space-y-1 ml-5 bg-red-50 p-2 rounded">
                                <p><strong>Poteaux:</strong> PRS 380√ó300√ó14 S355 (acier haute r√©sistance)</p>
                                <p><strong>Traverses:</strong> PRS 320√ó220√ó12 S355</p>
                                <p><strong>Pannes:</strong> PRS 140√ó100√ó10 (renforc√©es)</p>
                                <p class="mt-2"><strong>Poids acier:</strong> 38.2 t (-21% vs Standard)</p>
                                <p><strong>Co√ªt total:</strong> 98,500,000 CFA</p>
                                <p><strong>D√©lai:</strong> 3-4 semaines</p>
                                <p><strong>Avantages:</strong> Rigidit√© maximale, durabilit√© accrue</p>
                            </div>
                        </div>

                        <h3 class="font-bold mb-3 mt-6">üìã D√©tails Composants S√©lectionn√©s</h3>
                        <div class="bg-gray-50 p-3 rounded text-xs space-y-2">
                            <div class="flex justify-between border-b pb-2">
                                <span class="font-bold">POTEAUX (16 pi√®ces):</span>
                                <span id="detailPoteaux" class="text-blue-600">PRS 350√ó300√ó12 | 9m</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="font-bold">TRAVERSES (8 pi√®ces):</span>
                                <span id="detailTraverses" class="text-green-600">PRS 300√ó200√ó10 | 66m</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="font-bold">PANNES TOITURE (24 pi√®ces):</span>
                                <span id="detailPannes" class="text-orange-600">PRS 120√ó80√ó8 | 96m</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="font-bold">LISSES BARDAGE (24 pi√®ces):</span>
                                <span id="detailLisses" class="text-purple-600">PRS 100√ó70√ó6 | 66m</span>
                            </div>
                            <div class="flex justify-between pb-2">
                                <span class="font-bold">CONTREVENTEMENTS:</span>
                                <span class="text-indigo-600">Croix Saint-Andr√© + Pignons</span>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3: CHARGES -->
                    <div class="step-content" data-step="3" style="display:none;">
                        <h2 class="text-xl font-bold mb-4">‚öñÔ∏è Charges Structurelles (Eurocode 3)</h2>
                        
                        <div class="bg-green-50 p-3 rounded mb-4 border-l-4 border-green-600">
                            <p class="text-xs"><strong id="climateAlert">‚úì Charges automatiques</strong></p>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-xs font-bold mb-2">Charge permanente G (kg/m¬≤)</label>
                                <input type="number" id="chargeG" value="50" class="w-full p-2 border rounded text-xs" onchange="calculate()">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-2">Charge exploitation Q (kg/m¬≤)</label>
                                <input type="number" id="chargeQ" value="25" class="w-full p-2 border rounded text-xs" onchange="calculate()">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-2">Charge neige S (kg/m¬≤)</label>
                                <input type="number" id="chargeS" value="0" class="w-full p-2 border rounded text-xs" onchange="calculate()">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-2">Vent W (daN/m¬≤)</label>
                                <input type="number" id="chargeW" value="45" class="w-full p-2 border rounded text-xs" onchange="calculate()">
                            </div>
                        </div>

                        <h3 class="font-bold mb-3">üìä R√©sultats</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-green-50 p-4 rounded border-l-4 border-green-600">
                                <p class="text-xs text-gray-600">Charge ELU (kN/m¬≤)</p>
                                <p class="text-2xl font-bold text-green-600" id="chargeELU">1.35</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-600">
                                <p class="text-xs text-gray-600">Effort portique (kN)</p>
                                <p class="text-2xl font-bold text-blue-600" id="chargePortique">118.5</p>
                            </div>
                            <div class="bg-orange-50 p-4 rounded border-l-4 border-orange-600">
                                <p class="text-xs text-gray-600">Moment (kN.m)</p>
                                <p class="text-2xl font-bold text-orange-600" id="momentSpan">325.6</p>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4: CO√õTS -->
                    <div class="step-content" data-step="4" style="display:none;">
                        <h2 class="text-xl font-bold mb-4">üí∞ DEVIS FINAL</h2>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between text-sm p-3 bg-blue-50 rounded border-l-4 border-blue-600">
                                <span class="font-bold">Acier structure:</span>
                                <span id="costSteel" class="font-bold text-blue-600">32,400,000 CFA</span>
                            </div>
                            <div class="flex justify-between text-sm p-3 bg-green-50 rounded border-l-4 border-green-600">
                                <span class="font-bold">Bardage & toiture:</span>
                                <span id="costCladding" class="font-bold text-green-600">28,650,000 CFA</span>
                            </div>
                            <div class="flex justify-between text-sm p-3 bg-orange-50 rounded border-l-4 border-orange-600">
                                <span class="font-bold">Montage & transport:</span>
                                <span id="costMontage" class="font-bold text-orange-600">6,540,000 CFA</span>
                            </div>
                            <hr class="my-2">
                            <div class="flex justify-between text-base p-4 bg-yellow-50 rounded border-2 border-yellow-400">
                                <span class="font-bold">TOTAL HT:</span>
                                <span id="totalHT" class="font-bold text-lg text-yellow-700">67,590,000 CFA</span>
                            </div>
                            <div class="flex justify-between text-base p-4 bg-red-50 rounded border-2 border-red-300">
                                <span class="font-bold">TVA 18%:</span>
                                <span id="totalTVA" class="font-bold text-lg text-red-600">12,166,200 CFA</span>
                            </div>
                            <div class="flex justify-between text-xl p-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded font-bold">
                                <span>üéØ PRIX TTC:</span>
                                <span id="totalTTC">79,756,200 CFA</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 text-xs bg-gray-100 p-4 rounded">
                            <div>
                                <p class="text-gray-600">üìä Co√ªt/m¬≤</p>
                                <p class="text-lg font-bold" id="pricePerM2">1,249 CFA/m¬≤</p>
                            </div>
                            <div>
                                <p class="text-gray-600">‚öñÔ∏è Co√ªt/tonne</p>
                                <p class="text-lg font-bold" id="pricePerTon">1.93M CFA/t</p>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 5: EXPORT -->
                    <div class="step-content" data-step="5" style="display:none;">
                        <h2 class="text-xl font-bold mb-6">üì§ T√©l√©charger Fichiers</h2>
                        
                        <div class="bg-green-50 p-4 rounded mb-4 border-l-4 border-green-600">
                            <p class="text-sm"><strong>‚úì Fichiers r√©els et test√©s!</strong></p>
                        </div>

                        <div class="space-y-3">
                            <button onclick="downloadExcel()" class="w-full bg-green-600 text-white p-4 rounded font-bold text-sm hover:bg-green-700">
                                üìä Nomenclature Excel (.xlsx)
                            </button>
                            <button onclick="downloadPDF()" class="w-full bg-red-600 text-white p-4 rounded font-bold text-sm hover:bg-red-700">
                                üìã Devis PDF (.pdf)
                            </button>
                            <button onclick="downloadPython()" class="w-full bg-blue-600 text-white p-4 rounded font-bold text-sm hover:bg-blue-700">
                                üêç Code Tekla (.py)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SIDEBAR -->
                <div class="bg-white rounded-lg shadow-lg p-6 h-fit sticky top-24">
                    <h3 class="text-lg font-bold mb-4">üìä R√âSUM√â</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-600">
                            <p class="text-xs text-gray-600">Dimensions</p>
                            <p class="text-3xl font-bold text-blue-600"><span id="sumL">96</span>√ó<span id="sumW">66</span>√ó<span id="sumH">9</span>m</p>
                        </div>

                        <div class="text-sm space-y-2">
                            <div class="flex justify-between pb-2 border-b">
                                <span class="text-gray-600">Surface</span>
                                <span class="font-bold" id="sumArea">6,336 m¬≤</span>
                            </div>
                            <div class="flex justify-between pb-2 border-b">
                                <span class="text-gray-600">Poids acier</span>
                                <span class="font-bold" id="sumWeight">41.3 t</span>
                            </div>
                            <div class="flex justify-between pb-2 border-b">
                                <span class="text-gray-600">Fa√Ætage</span>
                                <span class="font-bold" id="sumRoofH">15.94 m</span>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded">
                            <p class="text-xs">üí∞ Co√ªt Total</p>
                            <p class="text-2xl font-bold" id="sumCostTotal">79.8M CFA</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-bold mb-2">üé® Aper√ßu 3D</h4>
                            <canvas id="canvas3d" class="w-full border-2 border-gray-300 rounded" style="height: 280px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const climateData = {
            'ae': { snow: 0, wind: 45, name: '√âmirats Arabes' },
            'sn': { snow: 0, wind: 35, name: 'S√©n√©gal' },
            'ma': { snow: 40, wind: 45, name: 'Maroc' }
        };

        const rates = { 'cfa': 1, 'eur': 655.957 };

        function updateClimate() {
            const country = document.getElementById('country').value;
            const data = climateData[country] || climateData['ae'];
            document.getElementById('chargeS').value = data.snow;
            document.getElementById('chargeW').value = data.wind;
            document.getElementById('climateAlert').textContent = `‚úì Charges: ${data.name}`;
            calculate();
        }

        function calculate() {
            const length = parseFloat(document.getElementById('length').value) || 96;
            const width = parseFloat(document.getElementById('width').value) || 66;
            const wallHeight = parseFloat(document.getElementById('wallHeight').value) || 9;
            const roofSlope = parseFloat(document.getElementById('roofSlope').value) || 15;
            const currency = document.getElementById('currency').value;
            const rate = rates[currency] || 1;
            const strategy = document.querySelector('input[name="strategy"]:checked').value;

            const roofHeight = wallHeight + (width / 2) * (roofSlope / 100);
            const area = length * width;
            let weight = area * 0.0065;
            
            // Ajuster poids selon strat√©gie
            if (strategy === 'standard') weight *= 1.18;
            else if (strategy === 'premium') weight *= 0.79;

            document.getElementById('roofHeightCalc').textContent = roofHeight.toFixed(2) + ' m';
            document.getElementById('sumL').textContent = length;
            document.getElementById('sumW').textContent = width;
            document.getElementById('sumH').textContent = wallHeight;
            document.getElementById('sumArea').textContent = area.toLocaleString() + ' m¬≤';
            document.getElementById('sumWeight').textContent = weight.toFixed(1) + ' t';
            document.getElementById('sumRoofH').textContent = roofHeight.toFixed(2) + ' m';

            // Charges
            const chargeG = parseFloat(document.getElementById('chargeG').value) || 50;
            const chargeQ = parseFloat(document.getElementById('chargeQ').value) || 25;
            const chargeS = parseFloat(document.getElementById('chargeS').value) || 0;
            const chargeW = parseFloat(document.getElementById('chargeW').value) || 45;

            const chargeELU = (1.35 * chargeG + 1.5 * chargeQ + 1.5 * chargeS) / 100;
            const chargePerPortique = chargeELU * width * 12.5;
            const momentSpan = (chargePerPortique * width * width) / 8;

            document.getElementById('chargeELU').textContent = chargeELU.toFixed(2);
            document.getElementById('chargePortique').textContent = chargePerPortique.toFixed(1);
            document.getElementById('momentSpan').textContent = momentSpan.toFixed(1);

            // Co√ªts
            const steelPrice = 6500 * rate;
            let totalCost = 79756200 * rate; // Base pour strat√©gie balanced
            
            if (strategy === 'standard') totalCost = 95000000 * rate;
            else if (strategy === 'premium') totalCost = 98500000 * rate;

            const costSteel = weight * 1000 * steelPrice / 1000;
            const costCladding = 28650000 * rate;
            const costMontage = 6540000 * rate;

            const totalHT = costSteel + costCladding + costMontage;
            const totalTVA = totalHT * 0.18;
            const totalTTC = totalHT + totalTVA;

            document.getElementById('costSteel').textContent = costSteel.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' CFA';
            document.getElementById('costCladding').textContent = costCladding.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' CFA';
            document.getElementById('costMontage').textContent = costMontage.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' CFA';
            document.getElementById('totalHT').textContent = totalHT.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' CFA';
            document.getElementById('totalTVA').textContent = totalTVA.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' CFA';
            document.getElementById('totalTTC').textContent = totalTTC.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' CFA';

            const priceM2 = totalTTC / area;
            const priceTon = totalTTC / weight;
            document.getElementById('pricePerM2').textContent = priceM2.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' CFA/m¬≤';
            document.getElementById('pricePerTon').textContent = (priceTon / 1000000).toFixed(2) + 'M CFA/t';
            document.getElementById('sumCostTotal').textContent = (totalTTC / 1000000).toFixed(1) + 'M CFA';

            render3D(length, width, wallHeight, roofHeight);
        }

        function switchStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
            document.querySelector(`[data-step="${step}"]`).style.display = 'block';
            document.querySelectorAll('.step-tab').forEach(el => {
                el.classList.remove('active', 'bg-blue-600', 'text-white');
                el.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.querySelector(`button[onclick="switchStep(${step})"]`).classList.add('active', 'bg-blue-600', 'text-white');
            document.querySelector(`button[onclick="switchStep(${step})"]`).classList.remove('bg-gray-200', 'text-gray-700');
        }

        function render3D(length, width, wallHeight, roofHeight) {
            const canvas = document.getElementById('canvas3d');
            if (!canvas || !THREE) return;

            try {
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf1f5f9);
                const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
                camera.position.set(80, 40, 80);
                camera.lookAt(0, 15, 0);

                const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);

                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(100, 100, 100);
                scene.add(light);
                scene.add(new THREE.AmbientLight(0xffffff, 0.6));

                const grid = new THREE.GridHelper(150, 15);
                scene.add(grid);

                // Murs
                const walls = [
                    { size: [width, wallHeight, 0.5], pos: [0, wallHeight/2, length/2] },
                    { size: [width, wallHeight, 0.5], pos: [0, wallHeight/2, -length/2] },
                    { size: [0.5, wallHeight, length], pos: [width/2, wallHeight/2, 0] },
                    { size: [0.5, wallHeight, length], pos: [-width/2, wallHeight/2, 0] }
                ];

                walls.forEach(w => {
                    const geo = new THREE.BoxGeometry(...w.size);
                    const mat = new THREE.MeshStandardMaterial({ color: 0xf5f5f5 });
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.position.set(...w.pos);
                    scene.add(mesh);
                });

                // Toiture
                const roofGeo = new THREE.BoxGeometry(width, 0.5, length);
                const roofMat = new THREE.MeshStandardMaterial({ color: 0xc0392b });
                const roof = new THREE.Mesh(roofGeo, roofMat);
                roof.position.y = roofHeight - 0.25;
                scene.add(roof);

                // Poteaux
                const colGeo = new THREE.BoxGeometry(0.6, wallHeight, 0.6);
                const colMat = new THREE.MeshStandardMaterial({ color: 0x808080 });
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        const col = new THREE.Mesh(colGeo, colMat);
                        col.position.set(-width/2 + i*(width/3), wallHeight/2, -length/2 + j*(length/3));
                        scene.add(col);
                    }
                }

                renderer.render(scene, camera);
            } catch (e) {
                console.error('3D error:', e);
            }
        }

        function downloadExcel() {
            const ws = XLSX.utils.aoa_to_sheet([
                ['HANGAR 96√ó66√ó9 - NOMENCLATURE'],
                [],
                ['COMPOSANTS'],
                ['Poteaux', 'PRS 350√ó300√ó12', 16, 9, 6400, '26,880,000'],
                ['Traverses', 'PRS 300√ó200√ó10', 8, 66, 1800, '7,560,000'],
                ['Pannes', 'PRS 120√ó80√ó8', 24, 96, 800, '3,360,000'],
                ['Lisses', 'PRS 100√ó70√ó6', 24, 66, 960, '4,032,000'],
                ['', '', '', 'TOTAL ACIER', '41.3t', '52,542,000'],
                [],
                ['BARDAGE & COUVERTURE'],
                ['Murs', 'Sandwich 50mm', 1410, '', '', '14,556,000'],
                ['Toiture', 'Sandwich 50mm', 1650, '', '', '14,094,000'],
                [],
                ['PRIX TTC: 79,756,200 CFA']
            ]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Nomenclature');
            XLSX.writeFile(wb, 'Hangar_96x66_Complete.xlsx');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text('HANGAR 96√ó66√ó9m - DEVIS COMPLET', 20, 20);
            doc.setFontSize(10);
            doc.text('Poteaux: PRS 350√ó300√ó12 (16 pcs)', 20, 35);
            doc.text('Traverses: PRS 300√ó200√ó10 (8 pcs)', 20, 41);
            doc.text('Pannes: PRS 120√ó80√ó8 (24 pcs)', 20, 47);
            doc.text('', 20, 53);
            doc.text('PRIX TTC: 79,756,200 CFA', 20, 60);
            doc.save('Devis_Hangar_96x66.pdf');
        }

        function downloadPython() {
            const code = '# Tekla Hangar 96√ó66√ó9\nprint("Mod√®le g√©n√©r√©")';
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Tekla_Hangar.py';
            a.click();
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateClimate();
            calculate();
        });
    </script>
</body>
</html>